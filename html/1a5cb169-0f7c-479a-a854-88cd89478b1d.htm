<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-zh-CN.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>实体的状态</title><meta name="Language" content="zh-cn" /><meta name="Microsoft.Help.Id" content="1a5cb169-0f7c-479a-a854-88cd89478b1d" /><meta name="Description" content="实体仓库对实体的保存操作，是通过唯一的一个 Save 方法来完成的。而具体是执行 CDU 中的哪一个操作，则由传入的实体的状态来决定。实体的状态由 Entity.PersistenceStatus 属性决定，该属性的类型是枚举 PersistenceStatus，如下：" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Rafy User Guide<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy User Guide" tocid="roottoc">Rafy User Guide</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy框架" tocid="69b641cf-d1fe-4f06-877f-b479d268a3fc">Rafy框架</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="c8e6cd25-c674-4cd1-9880-816d11f58eb8.htm" title="领域实体框架" tocid="c8e6cd25-c674-4cd1-9880-816d11f58eb8">领域实体框架</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="e9998e68-31e8-47d6-9e28-829aade5044e.htm" title="领域实体" tocid="e9998e68-31e8-47d6-9e28-829aade5044e">领域实体</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="1a5cb169-0f7c-479a-a854-88cd89478b1d.htm" title="实体的状态" tocid="1a5cb169-0f7c-479a-a854-88cd89478b1d">实体的状态</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="e0e55ab2-1e48-4acd-96ef-c889774bfecc.htm" title="实体关系" tocid="e0e55ab2-1e48-4acd-96ef-c889774bfecc">实体关系</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="8c0065bc-f165-4c69-81f4-9c3c57bd9ab9.htm" title="实体属性" tocid="8c0065bc-f165-4c69-81f4-9c3c57bd9ab9">实体属性</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="640ac9bb-0090-4b38-9763-bad4fca3adfb.htm" title="领域实体关系图" tocid="640ac9bb-0090-4b38-9763-bad4fca3adfb">领域实体关系图</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="6b1f358e-0590-4d63-8697-b0a80349c4b0.htm" title="树型实体" tocid="6b1f358e-0590-4d63-8697-b0a80349c4b0">树型实体</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="Click or drag to resize" title="Click or drag to resize" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="Click or drag to resize" title="Click or drag to resize" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn">实体的状态</td></tr></table><span class="introStyle"></span><div class="introduction"><p>This topic contains the following sections:</p><ul class="autoOutline"><li class="outlineSectionEntry"><a href="#status">单个实体的状态</a></li><li class="outlineSectionEntry"><a href="#transfer">实体状态的转换</a></li><li class="outlineSectionEntry"><a href="#comStatus">组合实体的状态</a></li></ul></div><div class="collapsibleAreaRegion" id="status"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID1RB')" onkeypress="SectionExpandCollapse_CheckKey('ID1RB', event)" tabindex="0"><img id="ID1RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />单个实体的状态</span></div><div id="ID1RBSection" class="collapsibleSection"><p>
                    实体仓库对实体的保存操作，是通过唯一的一个 Save 方法来完成的。而具体是执行 CDU 中的哪一个操作，则由传入的实体的状态来决定。实体的状态由 <span class="code">Entity.PersistenceStatus</span> 属性决定，该属性的类型是枚举 <span class="code">PersistenceStatus</span>，如下：
                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EADADAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EADADAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID0EADADAAA');return false;" title="Copy">Copy</a></div></div><div id="ID0EADADAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">namespace</span> Rafy.Domain
{
    <span class="highlight-comment">/// &lt;summary&gt;</span>
    <span class="highlight-comment">/// 实体状态</span>
    <span class="highlight-comment">/// &lt;/summary&gt;</span>
    <span class="highlight-keyword">public</span> <span class="highlight-keyword">enum</span> PersistenceStatus
    {
        <span class="highlight-comment">/// &lt;summary&gt;</span>
        <span class="highlight-comment">/// 未改动</span>
        <span class="highlight-comment">/// &lt;/summary&gt;</span>
        Unchanged = <span class="highlight-number">0</span>,
        <span class="highlight-comment">/// &lt;summary&gt;</span>
        <span class="highlight-comment">/// 数据变更。仓库保存时，需要执行更新操作。</span>
        <span class="highlight-comment">/// &lt;/summary&gt;</span>
        Modified = <span class="highlight-number">1</span>,
        <span class="highlight-comment">/// &lt;summary&gt;</span>
        <span class="highlight-comment">/// 新对象。仓库保存时，需要执行添加操作。</span>
        <span class="highlight-comment">/// &lt;/summary&gt;</span>
        New = <span class="highlight-number">2</span>,
        <span class="highlight-comment">/// &lt;summary&gt;</span>
        <span class="highlight-comment">/// 已删除。仓库保存时，需要执行删除操作。</span>
        <span class="highlight-comment">/// &lt;/summary&gt;</span>
        Deleted = <span class="highlight-number">3</span>
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EADADAAA");</script><p>
                    单一实体对象在状态：<span class="code">New、Deleted、Modified</span> 中，并通过仓库保存时，对应在数据库中执行 Insert、Delete、Update(CDU) 操作。
                </p><p>
                    一些 ORM 框架实体类的实体状态中，还会额外有 Detached 或 Attached 状态，用于表示分布式应用程序环境下，实体是否已经与上下文脱离关系。而 Rafy 中的实体，本身就是脱离仓库而存在的，可直接用于分布式传输，所以没有这两个状态。（也就是说，通过仓库查询出来的实体，可直接绑定界面、传输至客户端，当界面层/客户端把修改过的实体传输回业务逻辑层并通过仓库进行保存时，无需考虑是否附加到仓库上下文中，直接保存即可。）
                </p><p>
                    为了方便状态的检测，Entity 还额外定义了几个冗余的属性：<span class="code">Entity.IsDeleted、Entity.IsNew、Entity.IsModified</span> 用于检测对象是否已经被删除、是否刚创建、是否已经被使用。另外，<span class="code">Entity.IsSelfDirty</span> 属性用于表示本实体是否处于需要保存的状态，即以上三种状态中任一一种。
                </p></div><div class="collapsibleAreaRegion" id="transfer"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />实体状态的转换</span></div><div id="ID2RBSection" class="collapsibleSection"><p>实体状态的自动转换：</p><ul><li><p>
                            当使用 new 操作符刚创建一个实体时，它的状态是 New；此实体如果通过仓库保存后，它的状态变更为 Unchanged。
                        </p></li><li><p>
                            一个刚从仓库中查询出来的实体，它的状态是 Unchanged；对此实体的任一属性进行修改时，它的状态自动变更为 Modified；如果继续通过仓库保存后，状态则会变回 Unchanged。
                        </p></li><li><p>
                            一个实体从实体列表中移除时（例如使用 EntityList.Remove 方法），它的状态变为 Deleted；通过仓库保存该实体后，它的状态变更为 New。（一个从仓库中完成删除后的实体，对于仓库来说，将是一个全新的实体。）
                        </p></li></ul><p>
                    实体状态的手动转换：在自动维护状态的基础上，也可以通过实体的以下方法来强制直接改变实体的状态：<span class="code">MarkUnchanged()、MarkDeleted()、MarkNew()、MarkSelfDirty()</span>。（注意，MarkSelfDirty 方法只会在实体状态为 Unchanged 时，把状态变更为 Modified；这样防止误把处于 New、Deleted 状态的实体直接改变为 Modified 而导致保存失败。）
                </p></div><div class="collapsibleAreaRegion" id="comStatus"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID3RB')" onkeypress="SectionExpandCollapse_CheckKey('ID3RB', event)" tabindex="0"><img id="ID3RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />组合实体的状态</span></div><div id="ID3RBSection" class="collapsibleSection"><p>
                    在通过实体仓库的 <span class="code">Save(Entity entity)</span> 方法保存传入的实体对象时，其实是对以该实体为根的整个组合实体树进行保存。也就是说，组合实体树中任一实体状态变更时，都会被保存。
                </p><p><span class="code">Entity.IsDirty</span> 属性表示整个组合实体是否需要保存。当该实体或者该实体组合中的组合子实体中，任一实体的 IsSelfDirty 状态为真时，整个组合实体的 IsDrity 为真。
                </p><p>
                    相应的，可以使用 <span class="code">Entity.MarkSaved()</span> 方法，来把整个组合实体树中的所有实体都标记为 Unchanged 状态。
                </p></div></div></div><div id="pageFooter" class="pageFooter">胡庆访 @版权所有，有问题请联系 9474649@qq.com。<div class="feedbackLink">有关这个主题的评论请发邮件到
        <a id="HT_MailLink" href="mailto:9474649%40qq.com?Subject=Rafy User Guide">发送反馈</a></div><script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>