<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-zh-CN.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>数据库同步功能</title><meta name="Language" content="zh-cn" /><meta name="Microsoft.Help.Id" content="b40cd779-ec8a-469d-82f5-bd99128561c4" /><meta name="Description" content="传统的 ORM 框架都是 DatabaseFirst 的开发模式，也就是先设计好数据库，再编写实体的代码，并配置 ORM 框架中实体与数据库间的映射关系。由于要同时关心这三个不同内容，使得开发人员的工作量变得很大，开发效率低下。" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Rafy User Guide<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy User Guide" tocid="roottoc">Rafy User Guide</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy框架" tocid="69b641cf-d1fe-4f06-877f-b479d268a3fc">Rafy框架</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="c8e6cd25-c674-4cd1-9880-816d11f58eb8.htm" title="领域实体框架" tocid="c8e6cd25-c674-4cd1-9880-816d11f58eb8">领域实体框架</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="0f6e3552-029f-4a32-9655-e4b6fb22edcc.htm" title="对象关系映射" tocid="0f6e3552-029f-4a32-9655-e4b6fb22edcc">对象关系映射</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="eba03db2-2a71-4499-9dcd-99e0c37fe10e.htm" title="配置映射" tocid="eba03db2-2a71-4499-9dcd-99e0c37fe10e">配置映射</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="8b3a3b78-9e6a-4558-938d-7692ae6aaa8f.htm" title="继承映射" tocid="8b3a3b78-9e6a-4558-938d-7692ae6aaa8f">继承映射</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="12520633-1fbf-45dc-aca8-c4089b5c90e0.htm" title="SQL 语句日志" tocid="12520633-1fbf-45dc-aca8-c4089b5c90e0">SQL 语句日志</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="b40cd779-ec8a-469d-82f5-bd99128561c4.htm" title="数据库同步功能" tocid="b40cd779-ec8a-469d-82f5-bd99128561c4">数据库同步功能</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="99366b1b-7583-4c95-9f78-3178b0bd50f9.htm" title="为数据库生成注释" tocid="99366b1b-7583-4c95-9f78-3178b0bd50f9">为数据库生成注释</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="ef53c777-dd02-4a01-98c9-7dcc49489cec.htm" title="多数据库支持" tocid="ef53c777-dd02-4a01-98c9-7dcc49489cec">多数据库支持</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="Click or drag to resize" title="Click or drag to resize" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="Click or drag to resize" title="Click or drag to resize" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn">数据库同步功能</td></tr></table><span class="introStyle"></span><div class="introduction"><p>本文包含以下章节：</p><ul class="autoOutline"><li class="outlineSectionEntry"><a href="#cf">CodeFirst 开发模式</a></li><li class="outlineSectionEntry"><a href="#use">使用方法</a></li><li class="outlineSectionEntry"><a href="#adv">高级</a></li></ul></div><div class="collapsibleAreaRegion" id="cf"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID0RB')" onkeypress="SectionExpandCollapse_CheckKey('ID0RB', event)" tabindex="0"><img id="ID0RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />CodeFirst 开发模式</span></div><div id="ID0RBSection" class="collapsibleSection"><p>传统的 ORM 框架都是 DatabaseFirst 的开发模式，也就是先设计好数据库，再编写实体的代码，并配置 ORM 框架中实体与数据库间的映射关系。由于要同时关心这三个不同内容，使得开发人员的工作量变得很大，开发效率低下。</p><p>在 Rafy 框架中，提倡开发人员采用 CodeFirst 的开发模式开发领域实体。即先编写领域实体的属性、关系的代码，然后由框架自动配置映射规则并生成目标数据库。这样的开发模式下，由于框架生成的数据库满足第三范式，使得开发人员通常都不用关心数据库结构及映射，大大提高开发效率。</p><p>框架的数据库同步模块，不但支持一次性生成完整的数据库，更重要的是支持渐近式更新数据库，会自动把实体上的变更实时同步到目标数据库上。例如，当为实体添加一个新的属性后，框架会为对应的表添加新的列，而不会删除历史表及数据。</p><p>优势：</p><ul><li><p>这种方式和敏捷开发的模式非常相似，可以不用一次性把实体类设计完整，而是随着对需求的理解越来越深刻，再逐步地完善实体类、数据库。</p></li><li><p>这也使得拥抱变化万能可能。软件开发过程中，需求变化时，数据库字段也经常会发生变化。而使用渐近式开发模式后，任何时候都可以随意地添加新的字段、删除旧的字段，而不会影响其它数据。</p></li></ul></div><div class="collapsibleAreaRegion" id="use"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />使用方法</span></div><div id="ID2RBSection" class="collapsibleSection"><p>
                    要打开数据库同步功能，我们需要在领域插件类型中使用领域服务 <span class="code">MigrateService</span> 来实现。以下代码在 JXC 领域插件中，开启了 JXC 数据库自动同步的功能：
                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EACACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EACACAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EACACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EACACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">public</span> <span class="highlight-keyword">class</span> JXCPlugin : DomainPlugin
{
    <span class="highlight-keyword">public</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">void</span> Initialize(IApp app)
    {
        <span class="highlight-comment">//在应用程序运行时启动时，才升级数据库。</span>
        app.RuntimeStarting += (o, e) =&gt; AutoUpdateDb();
    }

    <span class="highlight-comment">/// &lt;summary&gt;</span>
    <span class="highlight-comment">/// 自动升级数据库。</span>
    <span class="highlight-comment">/// &lt;/summary&gt;</span>
    <span class="highlight-keyword">private</span> <span class="highlight-keyword">static</span> <span class="highlight-keyword">void</span> AutoUpdateDb()
    {
        <span class="highlight-keyword">var</span> svc = ServiceFactory.Create&lt;MigrateService&gt;();
        svc.Options = <span class="highlight-keyword">new</span> MigratingOptions
        {
            <span class="highlight-comment">//ReserveHistory = true,//ReserveHistory 表示是否需要保存所有数据库升级的历史记录</span>
            <span class="highlight-comment">//RunDataLossOperation = DataLossOperation.All,//要支持数据库表、字段的删除操作，取消本行注释。</span>
            Databases = <span class="highlight-keyword">new</span> <span class="highlight-keyword">string</span>[] { JXCEntityRepository.DbSettingName }
        };
        svc.Invoke();
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EACACAAA");</script><p>使用时，需要注意以下几点：</p><ul><li><p>自动同步数据库的代码，需要在应用程序运行时生成周期开始时执行。这时，应用程序中所有实体的属性已经初始化完成，才能同步出正确的数据库。</p></li><li><p>默认没有开启日志记录功能，可以设置 ReserveHistory = true 来记录所有数据库同步日志。</p><p>打开日志记录功能后，框架会自动生成一个专门用于存储日志的数据库，该库可通过 DbMigrationHistory 连接字符串配置名进行配置。</p></li><li><p>默认不会执行所有会造成数据丢失的操作（删除列、删除表），要执行删除操作，需要设置 RunDataLossOperation 属性。</p></li></ul></div><div class="collapsibleAreaRegion" id="adv"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID3RB')" onkeypress="SectionExpandCollapse_CheckKey('ID3RB', event)" tabindex="0"><img id="ID3RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />高级</span></div><div id="ID3RBSection" class="collapsibleSection"><p>如果期望更细粒度地控制数据库同步功能，可以使用 RafyDbMigrationContext 类型来完成。</p></div></div></div><div id="pageFooter" class="pageFooter">胡庆访 @版权所有，有问题请联系 9474649@qq.com。<div class="feedbackLink">有关这个主题的评论请发邮件到
        <a id="HT_MailLink" href="mailto:9474649%40qq.com?Subject=Rafy User Guide">发送反馈</a></div><script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>