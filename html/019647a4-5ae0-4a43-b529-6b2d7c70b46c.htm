<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-zh-CN.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>实体的创建、删除、修改</title><meta name="Language" content="zh-cn" /><meta name="Microsoft.Help.Id" content="019647a4-5ae0-4a43-b529-6b2d7c70b46c" /><meta name="Description" content="实体仓库对实体的创建、删除、修改操作，与实体的状态密切相关。关于实体的状态，参见：" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Rafy User Guide<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy User Guide" tocid="roottoc">Rafy User Guide</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy框架" tocid="69b641cf-d1fe-4f06-877f-b479d268a3fc">Rafy框架</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="c8e6cd25-c674-4cd1-9880-816d11f58eb8.htm" title="领域实体框架" tocid="c8e6cd25-c674-4cd1-9880-816d11f58eb8">领域实体框架</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="6b377084-3fc9-4bf6-94d7-bc9a42ed82a7.htm" title="实体仓库" tocid="6b377084-3fc9-4bf6-94d7-bc9a42ed82a7">实体仓库</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="019647a4-5ae0-4a43-b529-6b2d7c70b46c.htm" title="实体的创建、删除、修改" tocid="019647a4-5ae0-4a43-b529-6b2d7c70b46c">实体的创建、删除、修改</a></div><div class="toclevel2" data-toclevel="2"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="59c80aec-c910-4880-b165-c3495ed5eb3e.htm" title="编写查询" tocid="59c80aec-c910-4880-b165-c3495ed5eb3e">编写查询</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="c70274b4-8afc-4bd4-82d9-6e43ae7562ee.htm" title="大批量导入实体" tocid="c70274b4-8afc-4bd4-82d9-6e43ae7562ee">大批量导入实体</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="Click or drag to resize" title="Click or drag to resize" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="Click or drag to resize" title="Click or drag to resize" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn">实体的创建、删除、修改</td></tr></table><span class="introStyle"></span><div class="introduction"><p>本文包含以下章节：</p><ul class="autoOutline"><li class="outlineSectionEntry"><a href="#intro">实体状态</a></li><li class="outlineSectionEntry"><a href="#add">创建实体</a></li><li class="outlineSectionEntry"><a href="#del">删除</a></li><li class="outlineSectionEntry"><a href="#modi">修改</a></li><li class="outlineSectionEntry"><a href="#addCom">创建组合实体</a></li><li class="outlineSectionEntry"><a href="#delCom">删除组合实体</a></li><li class="outlineSectionEntry"><a href="#modiCom">修改组合实体</a></li><li class="outlineSectionEntry"><a href="#com">注意</a></li></ul></div><div class="collapsibleAreaRegion" id="intro"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID0RB')" onkeypress="SectionExpandCollapse_CheckKey('ID0RB', event)" tabindex="0"><img id="ID0RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />实体状态</span></div><div id="ID0RBSection" class="collapsibleSection"><p>
                    实体仓库对实体的创建、删除、修改操作，与实体的状态密切相关。关于实体的状态，参见：<a href="1a5cb169-0f7c-479a-a854-88cd89478b1d.htm">实体的状态</a></p></div><div class="collapsibleAreaRegion" id="add"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />创建实体</span></div><div id="ID2RBSection" class="collapsibleSection"><p>
                    可使用 <span class="code">new</span> 操作符来创建新实体，并直接保存到仓库中。
                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAAHAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAAHAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EAAAHAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EAAAHAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">BookRepository repo = RF.Concrete&lt;BookRepository&gt;();
repo.Save(<span class="highlight-keyword">new</span> Book());</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAAHAAA");</script></div><div class="collapsibleAreaRegion" id="del"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID3RB')" onkeypress="SectionExpandCollapse_CheckKey('ID3RB', event)" tabindex="0"><img id="ID3RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />删除</span></div><div id="ID3RBSection" class="collapsibleSection"><p>
                    通过 <span class="code">PersistenceStatus</span> 属性把实体的状态标记为需要删除后，调用保存即可从仓库中删除该实体。
                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAEAGAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAEAGAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EAEAGAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EAEAGAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">BookRepository repo = RF.Concrete&lt;BookRepository&gt;();
Book book = repo.GetById(<span class="highlight-number">1</span>);
book.PersistenceStatus = PersistenceStatus.Deleted;
repo.Save(book);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAEAGAAA");</script><p>另外，如果把一个实体从实体列表中移除后，再保存该列表，也可以达到删除该实体的效果：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EACAGAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EACAGAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EACAGAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EACAGAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">BookRepository repo = RF.Concrete&lt;BookRepository&gt;();
BookList bookList = repo.GetAll();
<span class="highlight-keyword">if</span> (bookList.Count &gt; <span class="highlight-number">0</span>)
{
    bookList.RemoveAt(<span class="highlight-number">0</span>);
}
repo.Save(bookList);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EACAGAAA");</script><p>以下代码，则会导致从数据库中删除所有的书籍：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAAGAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAAGAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EAAAGAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EAAAGAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">BookRepository repo = RF.Concrete&lt;BookRepository&gt;();
BookList bookList = repo.GetAll();
bookList.Clear();
repo.Save(bookList);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAAGAAA");</script></div><div class="collapsibleAreaRegion" id="modi"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID4RB')" onkeypress="SectionExpandCollapse_CheckKey('ID4RB', event)" tabindex="0"><img id="ID4RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />修改</span></div><div id="ID4RBSection" class="collapsibleSection"><p>
                    对于查询出来的实体，在修改其至少一个属性后，可以对其进行保存。
                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAAFAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAAFAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EAAAFAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EAAAFAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">BookRepository repo = RF.Concrete&lt;BookRepository&gt;();
Book book = repo.GetById(<span class="highlight-number">1</span>);
book.Name = <span class="highlight-literal">"New Name"</span>;
repo.Save(book);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAAFAAA");</script></div><div class="collapsibleAreaRegion" id="addCom"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID5RB')" onkeypress="SectionExpandCollapse_CheckKey('ID5RB', event)" tabindex="0"><img id="ID5RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />创建组合实体</span></div><div id="ID5RBSection" class="collapsibleSection"><p>
                    组合实体的保存，可直接通过组合根保存，即可完成整个组合树中所有实体的保存。（在保存根实体时，框架会调用组合子实体的仓库来保存这些组合子实体。）
                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EABAEAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EABAEAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EABAEAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EABAEAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">//创建一个有四个轮子的汽车</span>
Car car = <span class="highlight-keyword">new</span> Car();
car.WheelList.Add(<span class="highlight-keyword">new</span> Wheel());
car.WheelList.Add(<span class="highlight-keyword">new</span> Wheel());
car.WheelList.Add(<span class="highlight-keyword">new</span> Wheel());
car.WheelList.Add(<span class="highlight-keyword">new</span> Wheel());

<span class="highlight-keyword">var</span> repo = RF.Concrete&lt;CarRepository&gt;();
repo.Save(car);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EABAEAAA");</script><p>注意，上例中，也可以直接使用 WheelRepository 来保存每一个 Wheel。</p></div><div class="collapsibleAreaRegion" id="delCom"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID6RB')" onkeypress="SectionExpandCollapse_CheckKey('ID6RB', event)" tabindex="0"><img id="ID6RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />删除组合实体</span></div><div id="ID6RBSection" class="collapsibleSection"><p>
                    删除组合根实体时，它组合的所有子实体也都同时被删除。
                </p><p>
                    由于组合实体的生成周期相关性，框架在把组合关系映射到数据库的外键关系时，会自动把该外键设计为级联删除。所以需要删除整个组合实体时，只需要删除其根实体，数据库会自动把与它关联的所有子实体也同时删除。
                </p><p>以下代码在删除小车时，也会删除与之对应的四个车轮：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EADADAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EADADAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EADADAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EADADAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">CarRepository repo = RF.Concrete&lt;CarRepository&gt;();
Car car = repo.GetById(<span class="highlight-number">1</span>);
car.Status = PersistenceStatus.Deleted;
repo.Save(car);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EADADAAA");</script><p>另外，框架也支持在内存中递归删除组合实体的子实体。例如，如果组合关系对应的外键在元数据配置时，被手动配置为不级联删除，那么要删除整个组合对象，就需要打开内存删除功能：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EABADAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EABADAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EABADAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EABADAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">public</span> <span class="highlight-keyword">partial</span> <span class="highlight-keyword">class</span> CarRepository : JXCEntityRepository
{
    <span class="highlight-comment">/// &lt;summary&gt;</span>
    <span class="highlight-comment">/// 打开内存中删除组合子实体的功能</span>
    <span class="highlight-comment">/// &lt;/summary&gt;</span>
    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">bool</span> EnableDeletingChildrenInMemory
    {
        <span class="highlight-keyword">get</span> { <span class="highlight-keyword">return</span> <span class="highlight-keyword">true</span>; }
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EABADAAA");</script><div class="alert"><table><tr><th><img src="../icons/AlertNote.png" alt="Note" /> Note</th></tr><tr><td><p>注意，打开此功能后，由于框架会在内存中加载所有的组合子实体，而组合子实体较多时，则性能较差。建议不要轻易关闭数据库中组合关系的级联删除功能。</p></td></tr></table></div></div><div class="collapsibleAreaRegion" id="modiCom"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID7RB')" onkeypress="SectionExpandCollapse_CheckKey('ID7RB', event)" tabindex="0"><img id="ID7RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />修改组合实体</span></div><div id="ID7RBSection" class="collapsibleSection"><p>
                    组合实体树中任一实体状态变更，都可以通过直接保存组合根来保存整个组合树。如，以下代码把一个四轮小车改造为一个三轮车：
                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAACAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAACAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EAAACAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EAAACAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve">CarRepository repo = RF.Concrete&lt;CarRepository&gt;();
Car car = repo.GetById(<span class="highlight-number">1</span>);
car.WheelList.RemoveAt(<span class="highlight-number">3</span>);<span class="highlight-comment">//移除第四个轮子</span>
car.WheelList[<span class="highlight-number">0</span>].Weight = <span class="highlight-number">100</span>;<span class="highlight-comment">//第一个轮子重量改变</span>
repo.Save(car);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAACAAA");</script></div><div class="collapsibleAreaRegion" id="com"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID8RB')" onkeypress="SectionExpandCollapse_CheckKey('ID8RB', event)" tabindex="0"><img id="ID8RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />注意</span></div><div id="ID8RBSection" class="collapsibleSection"><p>
                    虽然经典的领域驱动要求，组合实体树中的所有实体都必须通过组合根实体来获取、操作、保存。但是根据大量的实践经验，Rafy 框架决定不强制要求这一点。也就是说，非组合根的实体，也可以直接通过该实体对应的仓库来完成创建、删除、修改的操作。
                </p></div></div></div><div id="pageFooter" class="pageFooter">有问题请联系 9474649@qq.com。<div class="feedbackLink">有关这个主题的评论请发邮件到
        <a id="HT_MailLink" href="mailto:9474649%40qq.com?Subject=Rafy User Guide">发送反馈</a></div><script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>