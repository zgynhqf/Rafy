<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-zh-CN.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>流水号插件</title><meta name="Language" content="zh-cn" /><meta name="Microsoft.Help.Id" content="1ce3c19a-3de6-4956-afd0-a7fc6e577768" /><meta name="Description" content="本文将解释 Rafy 框架中的流水插件的场景、使用方法。" /><meta name="Microsoft.Help.ContentType" content="Concepts" /><meta name="BrandingAware" content="true" /><link type="text/css" rel="stylesheet" href="../styles/highlight.css" /><script type="text/javascript" src="../scripts/highlight.js"> </script><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Rafy User Guide<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy User Guide" tocid="roottoc">Rafy User Guide</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="69b641cf-d1fe-4f06-877f-b479d268a3fc.htm" title="Rafy框架" tocid="69b641cf-d1fe-4f06-877f-b479d268a3fc">Rafy框架</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="2a81b03d-24b4-4463-9e57-34cbaa105adf.htm" title="现有插件" tocid="2a81b03d-24b4-4463-9e57-34cbaa105adf">现有插件</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="f662f88a-8221-49f4-bc38-901134ea893e.htm" title="幽灵插件" tocid="f662f88a-8221-49f4-bc38-901134ea893e">幽灵插件</a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="1ce3c19a-3de6-4956-afd0-a7fc6e577768.htm" title="流水号插件" tocid="1ce3c19a-3de6-4956-afd0-a7fc6e577768">流水号插件</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="Click or drag to resize" title="Click or drag to resize" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="Click or drag to resize" title="Click or drag to resize" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="titleColumn">流水号插件</td></tr></table><span class="introStyle"></span><div class="introduction"><p>本文将解释 Rafy 框架中的流水插件的场景、使用方法。</p><p>本文包含以下章节：</p><ul class="autoOutline"><li class="outlineSectionEntry"><a href="#senarios">场景</a></li><li class="outlineSectionEntry"><a href="#howto">使用方法</a></li></ul></div><div class="collapsibleAreaRegion" id="senarios"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID0RB')" onkeypress="SectionExpandCollapse_CheckKey('ID0RB', event)" tabindex="0"><img id="ID0RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />场景</span></div><div id="ID0RBSection" class="collapsibleSection"><p>在开发各类数据库应用系统时，往往需要生成从一开始的流水号，有时还需要按月或者按日进行独立生成，如下面的格式：2016031800000001、2016031800000002……。</p><p>设计本插件用于生成上述相应格式的编号。</p></div><div class="collapsibleAreaRegion" id="howto"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />使用方法</span></div><div id="ID2RBSection" class="collapsibleSection"><h3 class="procedureSubHeading">添加插件</h3><div class="subSection"><ol><li><p>通过 Nuget Package Manager 搜索并安装 Rafy.SerialNumber 插件。</p></li><li><p>在 DomainApp 中添加该插件；同时，设置该插件所对应的数据库配置名：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAAAABABAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAAAABABAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EAAAAABABAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EAAAAABABAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">class</span> JXCApp : DomainApp
{
    <span class="highlight-keyword">protected</span> <span class="highlight-keyword">override</span> <span class="highlight-keyword">void</span> InitEnvironment()
    {
        <span class="highlight-comment">//配置插件所对应的数据库配置名。</span>
        Rafy.SerialNumber.SerialNumberPlugin.DbSettingName = <span class="highlight-literal">"TestDb"</span>;

        <span class="highlight-comment">//添加流水号插件到 Rafy 应用程序集中。</span>
        RafyEnvironment.DomainPlugins.Add(<span class="highlight-keyword">new</span> Rafy.SerialNumber.SerialNumberPlugin());

        <span class="highlight-keyword">base</span>.InitEnvironment();
    }
}</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAAAABABAAA");</script></li></ol></div><h3 class="procedureSubHeading">使用插件</h3><div class="subSection"><ol><li><p>
                                    生成数据库。
                                </p><p>
                                    该插件中自带两个实体：<span class="code">SerialNumberInfo</span> 、<span class="code">SerialNumberValue</span> ，所以 Rafy 会为其在数据库中添加相应的两张表。
                                </p></li><li><p>
                                    添加流水号生成规则。
                                </p><p><span class="code">SerialNumberInfo</span> 表示定义的流水号生成规则信息。而 <span class="code">SerialNumberValue</span> 则表示生成的流水号的具体值。所以要生成流水号，必须先为其定义生成规则。可以使用 <span class="code">SerialNumberController</span> 进行简单的每日规则创建，示例如下：
                                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EACABAAABAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EACABAAABAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EACABAAABAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EACABAAABAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">var</span> controller = DomainControllerFactory.Create&lt;SerialNumberController&gt;();
<span class="highlight-keyword">var</span> sni = controller.CreateDailySerialNumberInfo(<span class="highlight-literal">"流水号规则-1"</span>);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EACABAAABAAA");</script><p>CreateDailySerialNumberInfo 方法内部其实非常简单，开发者可以参考以下代码创建新的生成规则，如下：</p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAABAAABAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAABAAABAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EAAABAAABAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EAAABAAABAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-comment">/// &lt;summary&gt;</span>
<span class="highlight-comment">/// 创建一个以日期进行分组生成编号的规则，存储到仓库中，并返回。</span>
<span class="highlight-comment">/// 性能-仓库访问次数：1。</span>
<span class="highlight-comment">/// &lt;/summary&gt;</span>
<span class="highlight-comment">/// &lt;param name="name"&gt;&lt;/param&gt;</span>
<span class="highlight-comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="highlight-keyword">public</span> SerialNumberInfo CreateDailySerialNumberInfo(<span class="highlight-keyword">string</span> name, <span class="highlight-keyword">string</span> format = <span class="highlight-literal">"yyyyMMdd********"</span>)
{
    <span class="highlight-keyword">var</span> sni = <span class="highlight-keyword">new</span> SerialNumberInfo
    {
        Name = name,
        TimeGroupFormat = <span class="highlight-literal">"yyyyMMdd"</span>,
        Format = format,
        RollValueStart = <span class="highlight-number">1</span>,
        RollValueStep = <span class="highlight-number">1</span>,
    };

    <span class="highlight-keyword">var</span> infoRepo = RF.Concrete&lt;SerialNumberInfoRepository&gt;();
    infoRepo.Save(sni);

    <span class="highlight-keyword">return</span> sni;
});</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAABAAABAAA");</script></li><li><p>
                                    生成流水号。
                                </p><p>
                                    使用以下代码生成流水号即可：
                                </p><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID1EAAAAAAABAAA_tab1" class="codeSnippetContainerTabSingle">C#</div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID1EAAAAAAABAAA_copyCode" href="#" onclick="javascript:CopyToClipboard('ID1EAAAAAAABAAA');return false;" title="Copy">Copy</a></div></div><div id="ID1EAAAAAAABAAA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="highlight-keyword">var</span> next = controller.GenerateNext(<span class="highlight-literal">"流水号规则-1"</span>);
Assert.AreEqual(<span class="highlight-literal">"2016031800000001"</span>, next);
next = controller.GenerateNext(<span class="highlight-literal">"流水号规则-1"</span>);
Assert.AreEqual(<span class="highlight-literal">"2016031800000002"</span>, next);
next = controller.GenerateNext(sni);
Assert.AreEqual(<span class="highlight-literal">"2016031800000002"</span>, next);</pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID1EAAAAAAABAAA");</script></li></ol></div></div></div></div><div id="pageFooter" class="pageFooter">有问题请联系 9474649@qq.com。<div class="feedbackLink">有关这个主题的评论请发邮件到
        <a id="HT_MailLink" href="mailto:9474649%40qq.com?Subject=Rafy User Guide">发送反馈</a></div><script type="text/javascript">
        var HT_mailLink = document.getElementById("HT_MailLink");
        var HT_mailLinkText = HT_mailLink.innerHTML;
        HT_mailLink.href += ": " + document.title + "\u0026body=" + encodeURIComponent("Your feedback is used to improve the documentation and the product. Your e-mail address will not be used for any other purpose and is disposed of after the issue you report is resolved. While working to resolve the issue that you report, you may be contacted via e-mail to get further details or clarification on the feedback you sent. After the issue you report has been addressed, you may receive an e-mail to let you know that your feedback has been addressed.");
        HT_mailLink.innerHTML = HT_mailLinkText;
        </script></div></body></html>